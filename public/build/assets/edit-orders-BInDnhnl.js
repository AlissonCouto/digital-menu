jQuery(function(e){e("body").on("click","#error-order-form #close-errors",function(t){e("#error-order-form").remove()});let N=e("#initial-cart").val();p(JSON.parse(N)),h(),e("#adminOrderCreate").on("submit",function(t){t.preventDefault();let i=M();if(i.length>0){var a='<ul class="list-errors">';i.forEach(r=>{a+=`<li>${r}<li>`}),a+="</ul>",D(a)}else{let r=u();e("<input>").attr({type:"hidden",name:"order",value:JSON.stringify(r)}).appendTo("#adminOrderCreate"),this.submit()}}),e("body").on("click","#flavor-remove",function(t){let i=e(this).closest(".flavors").find(".flavor"),a=e(this).closest(".flavor"),r=a.attr("id");i.length==1?e("#customizable-items").html(`
                <div class="empty">
                    <strong>Selecione um item personalizável acima</strong>
                    <span>para iniciar a edição</span>
                </div>
            `):(a.remove(),e(`#modal-ingredients-${r}`).remove())}),e(document).keydown(function(t){var i=document.activeElement,a=e(i).attr("id"),r=e('#list-products .item input[name="selected-product"]:checked');if(t.key=="ArrowDown"){if(a=="product"){let o=r.closest("label"),n=o.next("label");n.length>0&&(r.attr("checked",!1),o.removeClass("-selected"),e(n).addClass("-selected"),e(n).find("input").prop("checked",!0))}}else if(t.key=="ArrowUp"){if(a=="product"){let o=r.closest("label"),n=o.prev("label");n.length>0&&(r.attr("checked",!1),o.removeClass("-selected"),e(n).addClass("-selected"),e(n).find("input").prop("checked",!0))}}else t.key=="Enter"&&a=="product"&&(e(".items-container #form-product #product").val(""),T())}),e("body").on("click","#list-products .item",function(t){t.target.tagName.toLowerCase()==="label"&&setTimeout(()=>{T()},20),e(".items-container #form-product #product").val("")}),e("body").on("click","#new-flavor",function(t){e("#modal-new-flavor").toggle()}),e("body").on("click",".create-orders .save-item",function(t){z({category:"pizzas"}),e(".items-container #form-product #product").val(""),e("#customizable-items").html(`
            <div class="empty">
                <strong>Selecione um item personalizável acima</strong>
                <span>para iniciar a edição</span>
            </div>
        `)}),e("#form-product").on("submit",function(t){t.preventDefault()}),e(".items-container #product").on("input",function(t){t.preventDefault();let i=e(this).val();i.length>=3?w(i):(e(".items-container #form-product #product").removeClass("-error"),e(".errorflavor").html(""),e("#list-products").css("display","none"),e("#list-products").html(""))}),e("body").on("click",".list-adresses .item .edit",function(t){t.preventDefault();let i=e(this).attr("href");X(i)}),e("body").on("change",".list-adresses .item .field",function(t){t.preventDefault();let i=e(this).val();e.ajax({url:i,dataType:"json",type:"get",success:function(a){if(a.success){let r=u();r.address=a.data,p(r),e(".tabs-data-clients #address").html(a.htmlAddress),e(`.tabs-data-clients #address #item-${a.data.id}`).prop("checked",!0)}},error:function(a){console.log("ERRO: ",a)}})}),e("body").on("click",".list-adresses .item .delete",function(t){t.preventDefault();let i=e(this).attr("href");O(i)}),e("body").on("click","#modal-address-delete .buttons button.delete",function(t){let i=e("#modal-address-delete #url input").val();i&&e.ajax({url:i,type:"get",dataType:"json",success:function(a){a.success&&e(".tabs-data-clients #address").html(a.htmlAddress)},error:function(a){console.log("ERRO: ",a)}}),O()}),e("body").on("click","#modal-options .btn-close, .customizable-items #button-options",function(t){e("#modal-options").toggle()}),e("body").on("click",".customizable-items .flavors .ingredients",function(t){let i=e(this).data("id");e(`#${i}`).toggle()}),e("body").on("click",".modal-ingredients .btn-close",function(t){e(this).closest(".modal-ingredients").toggle()}),e('.create-orders input[name="delivery-value"]').on("input",function(t){let i=e(this).val()||0,a=u();a.shipping=parseFloat(i),p(a),h()}),e('.create-orders .delivery-options input[name="delivery-method"]').on("change",function(t){let i=e(this).val();e(".create-orders .delivery-options label.item").removeClass("-checked"),e(this).closest("label.item").addClass("-checked");let a=u();if(a.deliveryMethod=i,i=="delivery"){let r=C();a.shipping=r}else a.shipping=0;e('.create-orders input[name="delivery-value"]').val(a.shipping),p(a),h()}),e('.create-orders .form-payments input[name="payment-form"]').on("change",function(t){e(".create-orders .form-payments label.item").removeClass("-checked"),e(this).closest("label.item").addClass("-checked");let i=u();i.formPayment=e(this).val(),p(i)}),e(".observations textarea").on("input",function(t){let i=u(),a=e(this).attr("id");i[a]=e(this).val(),p(i)}),e("body").on("click","#modal-address-delete button.btn-close, #modal-address-delete .buttons button.cancel",function(t){O()}),e(".overlayer-address").on("click",function(t){t.target==this&&O()});function O(t){typeof t<"u"&&e("#modal-address-delete #url").html(`<input type="hidden" value="${t}">`),e("#modal-address-delete").toggle()}e("body").on("submit","#updateClientModal",function(t){t.preventDefault();let i=e(this),a=i.attr("action"),r=i.serializeArray(),o={};e.each(r,function(){o[this.name]=this.value}),e.ajax({type:"PUT",url:a,contentType:"application/json",data:JSON.stringify(o),dataType:"json",headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},success:function(n){if(n.success==!0){let s=n.data,l=u();l.client={id:s.id,name:s.name,phone:s.phone},p(l),h(),n.htmlClient.length>0&&e(".tabs-data-clients #client").html(n.htmlClient)}},error:function(n){console.log("ERROR: ",n)}})}),e("body").on("submit","#createAddressModal",function(t){t.preventDefault();let i=e(this),a=i.attr("action"),r=i.serializeArray(),o={};e.each(r,function(){o[this.name]=this.value}),e.ajax({type:"post",url:a,contentType:"application/json",data:JSON.stringify(o),dataType:"json",headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},success:function(n){n.success==!0&&n.htmlAddress.length>0&&e(".tabs-data-clients #address").html(n.htmlAddress)},error:function(n){console.log("ERROR: ",n)}})}),e("body").on("submit","#editAddressModal",function(t){t.preventDefault();let i=e(this),a=i.attr("action"),r=i.serializeArray(),o={};e.each(r,function(){o[this.name]=this.value}),e.ajax({type:"post",url:a,contentType:"application/json",data:JSON.stringify(o),dataType:"json",headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},success:function(n){n.success==!0&&n.htmlAddress.length>0&&e(".tabs-data-clients #address").html(n.htmlAddress)},error:function(n){console.log("ERROR: ",n)}})}),e("body").on("change",'input[name="pizza_size"]',function(){e(this).closest(".options").find("label").removeClass("-checked"),e(this).closest("label").addClass("-checked");let i=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0),a=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0),r=e(`.create-orders .flavors input[name^="prices"][data-size="${e(this).val()}"]`),o=[];e(r).each((l,d)=>{o.push(e(d).val())});let n=o[0];o.length>1&&(n=o[0]>o[1]?o[0]:o[1]);let s=f(i+a+parseFloat(n));e(".create-orders .save-item .text").html(`Salvar item ${s}`)});function D(t){let i=`
            <div id="error-order-form" class="error-order-form">
                <div class="header">
                    <div class="icon rounded-circle">
                        <span><i class="mdi mdi-close"></i></span>
                    </div>
    
                    <button type="button" id="close-errors">
                        <i class="mdi mdi-close"></i>
                    </button>
                </div>
                
                ${t}
            </div>
        `;e("body").append(i),setTimeout(function(){e("#error-order-form").remove()},2e4)}function M(){let t=u(),i=[];return t.formPayment!="cash"&&t.formPayment!="credit-card"&&t.formPayment!="debit-card"&&i.push("Forma de pagamento inválida."),t.deliveryMethod!="delivery"&&t.deliveryMethod!="withdrawal"&&t.deliveryMethod!="comeget"&&i.push("Meio de entrega inválido."),Object.keys(t.client).length==0&&i.push("Selecione um cliente."),Object.keys(t.address).length==0&&i.push("Selecione um endereço."),t.items.length==0?i.push("O pedido está vazio."):(t.items.forEach(a=>{a.price.length==0&&i.push("Informe um preço para o item "+a.name+"."),k(a.price,2)||i.push("Verifique o preço do item "+a.name+"."),(typeof a.quantity!="number"||a.quantity<=0)&&i.push("Verifique a quantidade do item "+a.name+".")}),t.shipping>0&&(k(t.shipping,2)||i.push("Formato inválido na taxa de entrega.")),t.discounts>0&&(k(t.discounts,2)||i.push("Formato inválido no desconto.")),k(t.subtotal,2)||i.push("Formato inválido no subtotal do pedido."),k(t.total,2)||i.push("Formato inválido no valor do pedido.")),i}function k(t,i,a=0){return new RegExp(`^\\d+(\\.\\d{${a},${i}})?$`).test(t)}function C(){return e('meta[name="deliveryValue"]').attr("content")}function T(){let t=e('#list-products .item input[name="selected-product"]:checked').data("url"),i=[],a=e(".create-orders #customizable-items");if(a.find(".body-container").length>0){let r=a.find(".body .flavors .flavor").attr("id");i.push(r)}i.push(e('#list-products .item input[name="selected-product"]:checked').val()),e.ajax({url:t,dataType:"json",type:"get",data:{search:i},success:function(r){r.success==!0?(e(".items-container #form-product #product").removeClass("-error"),e(".errorflavor").html(""),e("#list-products").css("display","none"),e("#list-products").html(""),r.htmlProduct!=null&&r.htmlProduct.length>0&&e("#customizable-items").html(r.htmlProduct),r.htmlModalOptions!=null&&r.htmlModalOptions.length>0&&e("#modais").append(r.htmlModalOptions),r.category!="pizzas"&&z(r)):(e(".items-container #form-product #product").addClass("-error"),e(".errorflavor").html(r.message))},error:function(r){console.log("ERR ",r)}})}function w(t){let i=e(".items-container #form-product").attr("action");e.ajax({url:i,dataType:"json",type:"get",data:{search:t},success:function(a){a.success==!0?a.htmlProducts.length>0&&(e(".items-container #form-product #product").removeClass("-error"),e("#list-products").css("display","block"),e("#list-products").html(a.htmlProducts)):(e(".items-container #form-product #product").addClass("-error"),e("#list-products").css("display","block"),e("#list-products").html("Produto não encontrado."))},error:function(a){console.log("ERRO: ",a)}})}function _(){localStorage.removeItem("order"),h()}function u(){let t=L();return JSON.parse(localStorage.getItem("order"))||t}function L(){let t=0,i=e('.create-orders input[name="delivery-method"]:checked'),a=e('.create-orders .form-payments input[name="payment-form"]:checked');return i.length>0&&(t=C()),{client:{},address:{},items:[],comments_deliveryman:"",comments:"",formPayment:a.val(),deliveryMethod:i.val(),discounts:0,shipping:parseFloat(t)||0,subtotal:0,total:0}}function h(){let t=u(),i=t.address;var a=t.discounts,r=t.shipping,o=0,n=0;if(i&&B(i),e(".create-orders .order-resume .table-items").html(""),t.items.length==0)a=0,o=0,n=0,e("#discounts").val("0"),e("#discount_type").val("value"),e(".create-orders .clear-button").html(""),e(".create-orders .order-resume .table-items").html(`
                <tbody>
                    <tr>
                        <td colspan="4">
                            <div class="empty">
                                <div>Sem itens no pedido</div>
                            </div>
                        </td>
                    </tr>
                </tbody>   
            `);else{e(".create-orders .clear-button").html(`<a href="#" id="clear-order">
                                <i class="mdi mdi-delete"></i>
                                Limpar Pedido
                            </a>`),e(".create-orders .order-resume .table-items").html(`
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-center">Qtd</th>
                        <th>Preço</th>
                        <th>Total</th>
                    </tr>
                </thead>

                <tbody></tbody>    
            `);var s={};t.items.forEach(function(d){s.id=d.id,s.quantity=d.quantity,typeof d.products>"u"||d.products.length>1,s.title=d.name,s.price=d.price,o=o+=parseFloat(s.price)*s.quantity,R(s)})}n=o+parseFloat(r)-a,t.total=n,t.subtotal=o,t.shipping=r,t.discounts=a,p(t),e(".create-orders #total-order").html(`Total do Pedido: ${f(t.total)}`),e(".create-orders .save-item .text").html("Salvar item R$ 00,00")}function R(t){e(".create-orders .order-resume .table-items tbody").append(`
            <tr class="item" data-item-id="${t.id}">
                <td> <a data-id="${t.id}" id="remove-item" class="remove-item"><i class="mdi mdi-delete"></i></a> ${t.title}</td>
                <td class="text-center"><input data-id="${t.id}" id="update-quantity" min="1" class="update-quantity" type="number" value="${t.quantity}" /></td>
                <td>${f(t.price)}</td>
                <td>${f(t.price*t.quantity)}</td>
            </tr>
        `)}function J(t,i){let a=u();i=parseInt(i),i>0&&a.items.map(r=>{r.id==t&&(r.quantity=i)}),p(a),h(),S()}function V(t){let i=u(),a=i.items.filter(r=>r.id!=t);i.items=a||[],p(i),h()}function f(t){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)}function B(t){if(typeof t.street<"u"){let i=t.reference?" ("+t.reference+")":"";e(".create-orders .resume-address .address").html(`<i class="mdi mdi-map-marker"></i> ${t.street}, ${t.number}. ${t.neighborhood}${i}`)}else e(".create-orders .resume-address .address").html("")}function p(t){localStorage.setItem("order",JSON.stringify(t)),e("#debug-cart").html(JSON.stringify(u()))}function X(t){e.ajax({type:"get",url:t,contentType:"application/json",dataType:"json",success:function(i){if(i.success==!0){let a=i.data;i.data.length>0&&e(".tabs-data-clients #address").html(a)}},error:function(i){console.log("ERROR: ",i)}})}e("#addToOrder").on("click",function(t){z()}),e("body").on("input","#update-quantity",function(t){let i=e(this).val(),a=e(this).data("id");J(a,i)}),e("body").on("click","#remove-item",function(t){let i=e(this).data("id");V(i)}),e("body").on("click","#clear-order",function(t){t.preventDefault(),_()}),e("#discounts").on("change",function(t){S()}),e("#discount_type").on("change",function(t){S()}),e("body").on("change",'#modal-options input[name="pasta"]',function(t){let i=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0);if(e(this).data("price").length>0){let a=parseFloat(e(this).data("price")),r=parseFloat(e(".create-orders .save-item .text").data("price")),o=f(r+a+i);e(".create-orders .save-item .text").html(`Salvar item ${o}`)}else{let a=parseFloat(e(".create-orders .save-item .text").data("price")),r=f(a+i);e(".create-orders .save-item .text").html(`Salvar item ${r}`)}}),e("body").on("change",'#modal-options input[name="border"]',function(t){let i=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0);if(e(this).data("price").length>0){let a=parseFloat(e(this).data("price")),r=parseFloat(e(".create-orders .save-item .text").data("price")),o=f(r+a+i);e(".create-orders .save-item .text").html(`Salvar item ${o}`)}else{let a=parseFloat(e(".create-orders .save-item .text").data("price")),r=f(a+i);e(".create-orders .save-item .text").html(`Salvar item ${r}`)}}),e("body").on("change",'#modal-options input[name="pasta"], #modal-options input[name="border"]',function(t){let i=e('#modal-options input[name="pasta"]:checked'),a=e('#modal-options input[name="border"]:checked'),r=parseFloat(i.data("price")||0),o=parseFloat(a.data("price")||0);e(".create-orders .preferences .selected").html(""),i.data("name")!=null&&e(".create-orders .preferences .selected").append(`
        
                <strong>Massa:</strong> <span>${i.data("name")} ${r>0?": "+f(r):""}</span>
    
            `),a.data("name")!=null&&e(".create-orders .preferences .selected").append(`
        
                <br> <strong>Borda:</strong> <span>${a.data("name")} ${o>0?": "+f(o):""}</span>
    
            `)});function S(){let t=e("#discount_type").val(),i=e("#discounts").val(),a=u();i.length>0?t=="value"?a.discounts=parseFloat(i):t=="percent"&&(a.discounts=parseFloat(i)/100*(a.subtotal+a.shipping)):(e("#discounts").val("0"),a.discounts=0),a.discounts<a.subtotal+a.shipping&&(p(a),h())}function z(t){var i=u();let a=t.category;var r=e("#img").val(),o={},n=e("#observations").val(),s=1;if(a=="pizzas"){var l=e('input[name="pizza-checkbox"]:checked');let c=e('input[name="pizza_size"]:checked').data("size-name"),F=e('input[name="pizza_size"]:checked').val();var d=e('input[name="border"]:checked');let x={id:d.val(),name:d.data("name"),price:d.data("price")};var P=e('input[name="pasta"]:checked');let v={id:P.val(),name:P.data("name"),price:P.data("price")};switch(c){case"Grande":c="G";break;case"Média":c="M";break;default:c="B"}let b=0;if(l.length==1?b=e(l[0]).val()+"+"+c:b=e(l[0]).val()+"+"+e(l[1]).val()+"+"+c,i.items.find(y=>y.id===b))i.items.map(y=>{y.id==b&&(y.quantity+=s)}),g({message:"Adicionado ao carrinho",icon:'<i class="mdi mdi-check"></i>',type:"-success"});else if(l.length==0)g({message:"Selecione ao menos um sabor",icon:'<i class="mdi mdi-close"></i>',type:"-error"});else if(l.length>2)g({message:"Escolha no máximo dois sabores",icon:'<i class="mdi mdi-close"></i>',type:"-error"});else{var m=[];if(l.length==1){l.each(function(){m=q(this)});let y=m.productId+"+"+c,j="Pizza ("+c+") "+m.name,I=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0),E=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0);o={id:y,name:j,size:c,sizeId:F,border:x,pasta:v,price:parseFloat(m.price)+I+E,img:r,quantity:s,category:t.category,observations:n,products:m},i.items.push(o),g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"})}else{l.each(function(){let K=q(this);m.push(K)});let y=m[0].productId+"+"+m[1].productId+"+"+c,j=m[0].price>m[1].price?m[0].price:m[1].price,I="Pizza ("+c+") ";I+="1/2 "+m[0].name+" 1/2 "+m[1].name;let E=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0),G=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0);o={id:y,name:I,size:c,sizeId:F,price:parseFloat(j)+E+G,border:x,pasta:v,img:r,quantity:s,category:t.category,observations:n,products:m},i.items.push(o),g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"})}}e('input[name^="additional"]').prop("checked",!1),e('input[name="pizza-checkbox"]').prop("checked",!1)}else{let c=t.data[0],F=c.id;if(i.items.find(v=>v.id===F))i.items.map(v=>{v.id==F&&(v.quantity+=s)}),g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"});else{let v=c.id,b=c.price,A=c.name;o={id:v,name:A,price:b,quantity:s,category:t.category,observations:n},i.items.push(o)}g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"})}p(i),h()}function q(t){let i=e(t).val(),a=e(t).data("name"),r=e('input[name="pizza_size"]:checked').val(),o=e(`input[name="prices[${i}][${r}]"]`).val(),n=e('input[name="additional['+e(t).val()+']"]:checked'),s=[];n.length>0&&n.each(function(P){s.push({id:e(this).val(),name:e(this).data("name")})});let l=e('input[name="ingredient['+e(t).val()+']"]:not(:checked)'),d=[];return l.length>0&&l.each(function(P){d.push({id:e(this).val(),name:e(this).data("name")})}),{productId:i,name:a,price:o,additionals:s,removedIngredients:d}}function g(t){e("body").append(`
            <div id="card-notification" class="card-notification">
                <div
                class="icon rounded-circle ${t.type}">
                <span>${t.icon}</span>
                </div>
                ${t.message}
            </div>
        `),setTimeout(function(){e("#card-notification").remove()},3e3)}});
