jQuery(function(e){e("body").on("click","#error-order-form #close-errors",function(t){e("#error-order-form").remove()}),p(q()),h(),e("#adminOrderCreate").on("submit",function(t){t.preventDefault();let a=M();if(a.length>0){var i='<ul class="list-errors">';a.forEach(r=>{i+=`<li>${r}<li>`}),i+="</ul>",N(i)}else{let r=m();e("<input>").attr({type:"hidden",name:"order",value:JSON.stringify(r)}).appendTo("#adminOrderCreate"),this.submit()}}),e("body").on("click","#flavor-remove",function(t){let a=e(this).closest(".flavors").find(".flavor"),i=e(this).closest(".flavor"),r=i.attr("id");a.length==1?e("#customizable-items").html(`
                <div class="empty">
                    <strong>Selecione um item personalizável acima</strong>
                    <span>para iniciar a edição</span>
                </div>
            `):(i.remove(),e(`#modal-ingredients-${r}`).remove())}),e(document).keydown(function(t){var a=document.activeElement,i=e(a).attr("id"),r=e('#list-products .item input[name="selected-product"]:checked');if(t.key=="ArrowDown"){if(i=="product"){let o=r.closest("label"),s=o.next("label");s.length>0&&(r.attr("checked",!1),o.removeClass("-selected"),e(s).addClass("-selected"),e(s).find("input").prop("checked",!0))}}else if(t.key=="ArrowUp"){if(i=="product"){let o=r.closest("label"),s=o.prev("label");s.length>0&&(r.attr("checked",!1),o.removeClass("-selected"),e(s).addClass("-selected"),e(s).find("input").prop("checked",!0))}}else t.key=="Enter"&&i=="product"&&(e(".items-container #form-product #product").val(""),A())}),e("body").on("click","#list-products .item",function(t){t.target.tagName.toLowerCase()==="input"&&setTimeout(()=>{A()},20),e(".items-container #form-product #product").val("")}),e("body").on("click","#new-flavor",function(t){e("#modal-new-flavor").toggle()}),e("body").on("click",".create-orders .save-item",function(t){j({category:"pizzas"}),e(".items-container #form-product #product").val(""),e("#customizable-items").html(`
            <div class="empty">
                <strong>Selecione um item personalizável acima</strong>
                <span>para iniciar a edição</span>
            </div>
        `)}),e(".create-orders #whatsapp").on("keydown",function(t){e("#searchClient #name").val(""),e(".create-orders .resume-address .address").html("");let a=e(this).val();a.length>=8&&t.key=="Enter"&&(t.preventDefault(),I(a))}),e(".create-orders #name").on("input",function(t){t.preventDefault(),e("#searchClient #whatsapp").val(""),e(".create-orders .resume-address .address").html("");let a=e(this).val();a.length>=3&&I(a)}),e("body").on("click",".create-orders #list-clients .item",function(t){let a=e(this).data("phone");I(a),e(".create-orders #list-clients").css("display","none"),e(".create-orders #list-clients").html("")}),e("#form-product").on("submit",function(t){t.preventDefault()}),e(".items-container #product").on("input",function(t){t.preventDefault();let a=e(this).val();a.length>=3?_(a):(e(".items-container #form-product #product").removeClass("-error"),e(".errorflavor").html(""),e("#list-products").css("display","none"),e("#list-products").html(""))}),e("body").on("click",".list-adresses .item .edit",function(t){t.preventDefault();let a=e(this).attr("href");X(a)}),e("body").on("change",".list-adresses .item .field",function(t){t.preventDefault();let a=e(this).val();e.ajax({url:a,dataType:"json",type:"get",success:function(i){if(i.success){let r=m();r.address=i.data,p(r),e(".tabs-data-clients #address").html(i.htmlAddress),e(`.tabs-data-clients #address #item-${i.data.id}`).prop("checked",!0)}},error:function(i){console.log("ERRO: ",i)}})}),e("body").on("click",".list-adresses .item .delete",function(t){t.preventDefault();let a=e(this).attr("href");C(a)}),e("body").on("click","#modal-address-delete .buttons button.delete",function(t){let a=e("#modal-address-delete #url input").val();a&&e.ajax({url:a,type:"get",dataType:"json",success:function(i){i.success&&e(".tabs-data-clients #address").html(i.htmlAddress)},error:function(i){console.log("ERRO: ",i)}}),C()}),e("body").on("click","#modal-options .btn-close, .customizable-items #button-options",function(t){e("#modal-options").toggle()}),e("body").on("click",".customizable-items .flavors .ingredients",function(t){let a=e(this).data("id");e(`#${a}`).toggle()}),e("body").on("click",".modal-ingredients .btn-close",function(t){e(this).closest(".modal-ingredients").toggle()}),e('.create-orders input[name="delivery-value"]').on("input",function(t){let a=e(this).val()||0,i=m();i.shipping=parseFloat(a),p(i),h()}),e('.create-orders .delivery-options input[name="delivery-method"]').on("change",function(t){let a=e(this).val();e(".create-orders .delivery-options label.item").removeClass("-checked"),e(this).closest("label.item").addClass("-checked");let i=m();if(i.deliveryMethod=a,a=="delivery"){let r=T();i.shipping=r}else i.shipping=0;e('.create-orders input[name="delivery-value"]').val(i.shipping),p(i),h()}),e('.create-orders .form-payments input[name="payment-form"]').on("change",function(t){e(".create-orders .form-payments label.item").removeClass("-checked"),e(this).closest("label.item").addClass("-checked");let a=m();a.formPayment=e(this).val(),p(a)}),e(".observations textarea").on("input",function(t){let a=m(),i=e(this).attr("id");a[i]=e(this).val(),p(a)}),e("body").on("click","#modal-address-delete button.btn-close, #modal-address-delete .buttons button.cancel",function(t){C()}),e(".overlayer-address").on("click",function(t){t.target==this&&C()});function C(t){typeof t<"u"&&e("#modal-address-delete #url").html(`<input type="hidden" value="${t}">`),e("#modal-address-delete").toggle()}e("body").on("submit","#updateClientModal",function(t){t.preventDefault();let a=e(this),i=a.attr("action"),r=a.serializeArray(),o={};e.each(r,function(){o[this.name]=this.value}),e.ajax({type:"PUT",url:i,contentType:"application/json",data:JSON.stringify(o),dataType:"json",headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},success:function(s){if(s.success==!0){let n=s.data,d=m();d.client={id:n.id,name:n.name,phone:n.phone},p(d),h(),s.htmlClient.length>0&&e(".tabs-data-clients #client").html(s.htmlClient)}},error:function(s){console.log("ERROR: ",s)}})}),e("body").on("submit","#createAddressModal",function(t){t.preventDefault();let a=e(this),i=a.attr("action"),r=a.serializeArray(),o={};e.each(r,function(){o[this.name]=this.value}),e.ajax({type:"post",url:i,contentType:"application/json",data:JSON.stringify(o),dataType:"json",headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},success:function(s){s.success==!0&&s.htmlAddress.length>0&&e(".tabs-data-clients #address").html(s.htmlAddress)},error:function(s){console.log("ERROR: ",s)}})}),e("body").on("submit","#editAddressModal",function(t){t.preventDefault();let a=e(this),i=a.attr("action"),r=a.serializeArray(),o={};e.each(r,function(){o[this.name]=this.value}),e.ajax({type:"post",url:i,contentType:"application/json",data:JSON.stringify(o),dataType:"json",headers:{"X-CSRF-TOKEN":e('meta[name="csrf-token"]').attr("content")},success:function(s){s.success==!0&&s.htmlAddress.length>0&&e(".tabs-data-clients #address").html(s.htmlAddress)},error:function(s){console.log("ERROR: ",s)}})}),e("body").on("change",'input[name="pizza_size"]',function(){e(this).closest(".options").find("label").removeClass("-checked"),e(this).closest("label").addClass("-checked");let a=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0),i=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0),r=e(`.create-orders .flavors input[name^="prices"][data-size="${e(this).val()}"]`),o=[];e(r).each((d,l)=>{o.push(e(l).val())});let s=o[0];o.length>1&&(s=o[0]>o[1]?o[0]:o[1]);let n=f(a+i+parseFloat(s));e(".create-orders .save-item .text").html(`Salvar item ${n}`)});function N(t){let a=`
            <div id="error-order-form" class="error-order-form">
                <div class="header">
                    <div class="icon rounded-circle">
                        <span><i class="mdi mdi-close"></i></span>
                    </div>
    
                    <button type="button" id="close-errors">
                        <i class="mdi mdi-close"></i>
                    </button>
                </div>
                
                ${t}
            </div>
        `;e("body").append(a),setTimeout(function(){e("#error-order-form").remove()},2e4)}function M(){let t=m(),a=[];return t.formPayment!="cash"&&t.formPayment!="credit-card"&&t.formPayment!="debit-card"&&a.push("Forma de pagamento inválida."),t.deliveryMethod!="delivery"&&t.deliveryMethod!="withdrawal"&&t.deliveryMethod!="comeget"&&a.push("Meio de entrega inválido."),Object.keys(t.client).length==0&&a.push("Selecione um cliente."),Object.keys(t.address).length==0&&a.push("Selecione um endereço."),t.items.length==0?a.push("O pedido está vazio."):(t.items.forEach(i=>{i.price.length==0&&a.push("Informe um preço para o item "+i.name+"."),k(parseFloat(i.price).toFixed(2),2)||a.push("Verifique o preço do item "+i.name+"."),(typeof i.quantity!="number"||i.quantity<=0)&&a.push("Verifique a quantidade do item "+i.name+".")}),t.shipping>0&&(k(parseFloat(t.shipping).toFixed(2),2)||a.push("Formato inválido na taxa de entrega.")),t.discounts>0&&(k(parseFloat(t.discounts).toFixed(2),2)||a.push("Formato inválido no desconto.")),k(parseFloat(t.subtotal).toFixed(2),2)||a.push("Formato inválido no subtotal do pedido."),k(parseFloat(t.total).toFixed(2),2)||a.push("Formato inválido no valor do pedido.")),a}function k(t,a,i=0){return new RegExp(`^\\d+(\\.\\d{${i},${a}})?$`).test(t)}function T(){return e('meta[name="deliveryValue"]').attr("content")}function A(){let t=e('#list-products .item input[name="selected-product"]:checked').data("url"),a=[],i=e(".create-orders #customizable-items");if(i.find(".body-container").length>0){let r=i.find(".body .flavors .flavor").attr("id");a.push(r)}a.push(e('#list-products .item input[name="selected-product"]:checked').val()),e.ajax({url:t,dataType:"json",type:"get",data:{search:a},success:function(r){r.success==!0?(e(".items-container #form-product #product").removeClass("-error"),e(".errorflavor").html(""),e("#list-products").css("display","none"),e("#list-products").html(""),r.htmlProduct!=null&&r.htmlProduct.length>0&&e("#customizable-items").html(r.htmlProduct),r.htmlModalOptions!=null&&r.htmlModalOptions.length>0&&e("#modais").append(r.htmlModalOptions),r.category!="pizzas"&&j(r)):(e(".items-container #form-product #product").addClass("-error"),e(".errorflavor").html(r.message))},error:function(r){console.log("ERR ",r)}})}function _(t){let a=e(".items-container #form-product").attr("action");e.ajax({url:a,dataType:"json",type:"get",data:{search:t},success:function(i){i.success==!0?i.htmlProducts.length>0&&(e(".items-container #form-product #product").removeClass("-error"),e("#list-products").css("display","block"),e("#list-products").html(i.htmlProducts)):(e(".items-container #form-product #product").addClass("-error"),e("#list-products").css("display","block"),e("#list-products").html("Produto não encontrado."))},error:function(i){console.log("ERRO: ",i)}})}function I(t){let a=e(".create-orders #searchClient").attr("action");var i=[];e.ajax({dataType:"json",url:a,data:{search:t},success:function(r){if(r.success==!0){let o=r.data;if(typeof o.phone=="string"){r.htmlClient.length>0&&e(".tabs-data-clients #client").html(r.htmlClient),r.htmlAddress.length>0&&e(".tabs-data-clients #address").html(r.htmlAddress),r.htmlOrders.length>0&&e(".tabs-data-clients #historic").html(r.htmlOrders),e("#searchClient #whatsapp").removeClass("-error"),e("#searchClient #name").removeClass("-error"),e("#searchClient #whatsapp").val(o.phone),e("#searchClient #name").val(o.name),typeof o.addresses!=null&&(o.addresses,i=o.addresses.length>0?o.addresses[0]:[]);let s=m();s.client={id:o.id,name:o.name,phone:o.phone},s.address=i,p(s),h()}if(typeof o.phone>"u"){let s="";o.forEach(function(n){s+=`<div class="item" id="${n.id}" data-phone="${n.phone}">
                                        <span class="name">${n.name}</span>
                                        <span class="phone">${n.phone}</span>
                                      </div>`}),e(".create-orders #list-clients").css("display","block"),e(".create-orders #list-clients").html(s)}e(".create-orders .errorclient").html("")}else e("#searchClient #whatsapp").addClass("-error"),e("#searchClient #name").addClass("-error"),e(".create-orders .errorclient").html("Cliente não encontrado.")},error:function(r){console.log("ERRO: ",r)}})}function L(){localStorage.removeItem("order"),h()}function m(){let t=q();return JSON.parse(localStorage.getItem("order"))||t}function q(){let t=0,a=e('.create-orders input[name="delivery-method"]:checked'),i=e('.create-orders .form-payments input[name="payment-form"]:checked');return a.length>0&&(t=T()),{client:{},address:{},items:[],comments_deliveryman:"",comments:"",formPayment:i.val(),deliveryMethod:a.val(),discounts:0,shipping:parseFloat(t)||0,subtotal:0,total:0}}function h(){let t=m(),a=t.address;var i=t.discounts,r=t.shipping,o=0,s=0;if(a&&B(a),e(".create-orders .order-resume .table-items").html(""),t.items.length==0)i=0,o=0,s=0,e("#discounts").val("0"),e("#discount_type").val("value"),e(".create-orders .clear-button").html(""),e(".create-orders .order-resume .table-items").html(`
                <tbody>
                    <tr>
                        <td colspan="4">
                            <div class="empty">
                                <div>Sem itens no pedido</div>
                            </div>
                        </td>
                    </tr>
                </tbody>   
            `);else{e(".create-orders .clear-button").html(`<a href="#" id="clear-order">
                                <i class="mdi mdi-delete"></i>
                                Limpar Pedido
                            </a>`),e(".create-orders .order-resume .table-items").html(`
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-center">Qtd</th>
                        <th>Preço</th>
                        <th>Total</th>
                    </tr>
                </thead>

                <tbody></tbody>    
            `);var n={};t.items.forEach(function(l){n.id=l.id,n.quantity=l.quantity,typeof l.products>"u"||l.products.length>1,n.title=l.name,n.price=l.price,o=o+=parseFloat(n.price)*n.quantity,x(n)})}s=o+parseFloat(r)-i,t.total=s,t.subtotal=o,t.shipping=r,t.discounts=i,p(t),e(".create-orders #total-order").html(`Total do Pedido: ${f(t.total)}`),e(".create-orders .save-item .text").html("Salvar item R$ 00,00")}function x(t){e(".create-orders .order-resume .table-items tbody").append(`
            <tr class="item" data-item-id="${t.id}">
                <td> <a data-id="${t.id}" id="remove-item" class="remove-item"><i class="mdi mdi-delete"></i></a> ${t.title}</td>
                <td class="text-center"><input data-id="${t.id}" id="update-quantity" min="1" class="update-quantity" type="number" value="${t.quantity}" /></td>
                <td>${f(t.price)}</td>
                <td>${f(t.price*t.quantity)}</td>
            </tr>
        `)}function J(t,a){let i=m();a=parseInt(a),a>0&&i.items.map(r=>{r.id==t&&(r.quantity=a)}),p(i),h(),R()}function V(t){let a=m(),i=a.items.filter(r=>r.id!=t);a.items=i||[],p(a),h()}function f(t){return new Intl.NumberFormat("pt-BR",{style:"currency",currency:"BRL"}).format(t)}function B(t){if(typeof t.street<"u"){let a=t.reference?" ("+t.reference+")":"";e(".create-orders .resume-address .address").html(`<i class="mdi mdi-map-marker"></i> ${t.street}, ${t.number}. ${t.neighborhood}${a} - ${t.city.nome}/${t.city.uf}`)}else e(".create-orders .resume-address .address").html("")}function p(t){localStorage.setItem("order",JSON.stringify(t)),e("#debug-cart").html(JSON.stringify(m()))}function X(t){e.ajax({type:"get",url:t,contentType:"application/json",dataType:"json",success:function(a){if(a.success==!0){let i=a.data;a.data.length>0&&e(".tabs-data-clients #address").html(i)}},error:function(a){console.log("ERROR: ",a)}})}e("#addToOrder").on("click",function(t){j()}),e("body").on("input","#update-quantity",function(t){let a=e(this).val(),i=e(this).data("id");J(i,a)}),e("body").on("click","#remove-item",function(t){let a=e(this).data("id");V(a)}),e("body").on("click","#clear-order",function(t){t.preventDefault(),L()}),e("#discounts").on("change",function(t){R()}),e("#discount_type").on("change",function(t){R()}),e("body").on("change",'#modal-options input[name="pasta"]',function(t){let a=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0);if(e(this).data("price").length>0){let i=parseFloat(e(this).data("price")),r=parseFloat(e(".create-orders .save-item .text").data("price")),o=f(r+i+a);e(".create-orders .save-item .text").html(`Salvar item ${o}`)}else{let i=parseFloat(e(".create-orders .save-item .text").data("price")),r=f(i+a);e(".create-orders .save-item .text").html(`Salvar item ${r}`)}}),e("body").on("change",'#modal-options input[name="border"]',function(t){let a=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0);if(e(this).data("price").length>0){let i=parseFloat(e(this).data("price")),r=parseFloat(e(".create-orders .save-item .text").data("price")),o=f(r+i+a);e(".create-orders .save-item .text").html(`Salvar item ${o}`)}else{let i=parseFloat(e(".create-orders .save-item .text").data("price")),r=f(i+a);e(".create-orders .save-item .text").html(`Salvar item ${r}`)}}),e("body").on("change",'#modal-options input[name="pasta"], #modal-options input[name="border"]',function(t){let a=e('#modal-options input[name="pasta"]:checked'),i=e('#modal-options input[name="border"]:checked'),r=parseFloat(a.data("price")||0),o=parseFloat(i.data("price")||0);e(".create-orders .preferences .selected").html(""),a.data("name")!=null&&e(".create-orders .preferences .selected").append(`
        
                <strong>Massa:</strong> <span>${a.data("name")} ${r>0?": "+f(r):""}</span>
    
            `),i.data("name")!=null&&e(".create-orders .preferences .selected").append(`
        
                <br> <strong>Borda:</strong> <span>${i.data("name")} ${o>0?": "+f(o):""}</span>
    
            `)});function R(){let t=e("#discount_type").val(),a=e("#discounts").val(),i=m();a.length>0?t=="value"?i.discounts=parseFloat(a):t=="percent"&&(i.discounts=parseFloat(a)/100*(i.subtotal+i.shipping)):(e("#discounts").val("0"),i.discounts=0),i.discounts<i.subtotal+i.shipping&&(p(i),h())}function j(t){var a=m();let i=t.category;var r=e("#img").val(),o={},s=e("#observations").val(),n=1;if(i=="pizzas"){var d=e('input[name="pizza-checkbox"]:checked');let c=e('input[name="pizza_size"]:checked').data("size-name"),P=e('input[name="pizza_size"]:checked').val();var l=e('input[name="border"]:checked');let z={id:l.val(),name:l.data("name"),price:l.data("price")};var F=e('input[name="pasta"]:checked');let v={id:F.val(),name:F.data("name"),price:F.data("price")};switch(c){case"Grande":c="G";break;case"Média":c="M";break;default:c="B"}let b=0;if(d.length==1?b=e(d[0]).val()+"+"+c:b=e(d[0]).val()+"+"+e(d[1]).val()+"+"+c,a.items.find(y=>y.id===b))a.items.map(y=>{y.id==b&&(y.quantity+=n)}),g({message:"Adicionado ao carrinho",icon:'<i class="mdi mdi-check"></i>',type:"-success"});else if(d.length==0)g({message:"Selecione ao menos um sabor",icon:'<i class="mdi mdi-close"></i>',type:"-error"});else if(d.length>2)g({message:"Escolha no máximo dois sabores",icon:'<i class="mdi mdi-close"></i>',type:"-error"});else{var u=[];if(d.length==1){d.each(function(){u=w(this)});let y=u.productId+"+"+c,E="Pizza ("+c+") "+u.name,O=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0),S=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0);o={id:y,name:E,size:c,sizeId:P,border:z,pasta:v,price:parseFloat(u.price)+O+S,img:r,quantity:n,category:t.category,observations:s,products:u},a.items.push(o),g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"})}else{d.each(function(){let K=w(this);u.push(K)});let y=u[0].productId+"+"+u[1].productId+"+"+c,E=u[0].price>u[1].price?u[0].price:u[1].price,O="Pizza ("+c+") ";O+="1/2 "+u[0].name+" 1/2 "+u[1].name;let S=parseFloat(e('#modal-options input[name="border"]:checked').data("price")||0),G=parseFloat(e('#modal-options input[name="pasta"]:checked').data("price")||0);o={id:y,name:O,size:c,sizeId:P,price:parseFloat(E)+S+G,border:z,pasta:v,img:r,quantity:n,category:t.category,observations:s,products:u},a.items.push(o),g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"})}}e('input[name^="additional"]').prop("checked",!1),e('input[name="pizza-checkbox"]').prop("checked",!1)}else{let c=t.data[0],P=c.id;if(a.items.find(v=>v.id===P))a.items.map(v=>{v.id==P&&(v.quantity+=n)}),g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"});else{let v=c.id,b=c.price,D=c.name;o={id:v,name:D,price:b,quantity:n,category:t.category,observations:s},a.items.push(o)}g({message:"Adicionado ao pedido",icon:'<i class="mdi mdi-check"></i>',type:"-success"})}p(a),h()}function w(t){let a=e(t).val(),i=e(t).data("name"),r=e('input[name="pizza_size"]:checked').val(),o=e(`input[name="prices[${a}][${r}]"]`).val(),s=e('input[name="additional['+e(t).val()+']"]:checked'),n=[];s.length>0&&s.each(function(F){n.push({id:e(this).val(),name:e(this).data("name")})});let d=e('input[name="ingredient['+e(t).val()+']"]:not(:checked)'),l=[];return d.length>0&&d.each(function(F){l.push({id:e(this).val(),name:e(this).data("name")})}),{productId:a,name:i,price:o,additionals:n,removedIngredients:l}}function g(t){e("body").append(`
            <div id="card-notification" class="card-notification">
                <div
                class="icon rounded-circle ${t.type}">
                <span>${t.icon}</span>
                </div>
                ${t.message}
            </div>
        `),setTimeout(function(){e("#card-notification").remove()},3e3)}});
